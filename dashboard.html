<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        th {
            cursor: pointer;
            user-select: none;
        }
        th.sort-asc::after, th.sort-desc::after {
            content: '';
            display: inline-block;
            margin-left: 0.5em;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid currentColor;
        }
        th.sort-desc::after {
            border-top: 5px solid currentColor;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-xl font-bold text-gray-800">Admin Panel</div>
            <div>
                <a href="index.html" class="text-gray-600 hover:text-violet-600 px-3 py-2">Student View</a>
                <a href="dashboard.html" class="font-semibold text-violet-600 border-b-2 border-violet-600 px-3 py-2">Results Dashboard</a>
                <a href="create.html" class="text-gray-600 hover:text-violet-600 px-3 py-2">Create Quiz</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-8">
        <div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-6">
                 <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Student Results</h1>
                 <button id="refresh-button" class="bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Refresh</button>
            </div>
            <div id="loading-spinner" class="text-center py-10">
                <p>Loading results...</p>
            </div>
            <div id="results-container" class="overflow-x-auto hidden">
                <table class="min-w-full">
                    <thead>
                        <tr id="table-header" class="bg-gray-200 text-left text-sm font-semibold text-gray-600 uppercase">
                            <!-- Header will be generated by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="results-body" class="divide-y divide-gray-200">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMVkf9FKMJYoCfxI9knHZHicOpJiK-Td9yRHmi4n34riDj6t8F3kmYaDok3MjTYNAUQg/exec";

        // --- DOM ELEMENTS ---
        const headerRow = document.getElementById('table-header');
        const resultsBody = document.getElementById('results-body');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const refreshButton = document.getElementById('refresh-button');
        
        // --- STATE ---
        let allResults = [];
        let sortState = {
            column: 2, // Default sort by 'CompletionDate'
            ascending: false
        };

        /**
         * Renders the table with the currently sorted data
         */
        function renderTable() {
            if (!allResults || allResults.length === 0) return;

            // Create Header with sort indicators
            const headers = allResults[0];
            headerRow.innerHTML = headers.map((h, index) => 
                `<th class="py-3 px-4 ${sortState.column === index ? (sortState.ascending ? 'sort-asc' : 'sort-desc') : ''}" data-col-index="${index}">${h}</th>`
            ).join('');

            // Sort the data (all rows except the header)
            const dataRows = allResults.slice(1);
            dataRows.sort((a, b) => {
                let valA = a[sortState.column];
                let valB = b[sortState.column];

                // Special handling for numeric column (TimeInSeconds)
                if (sortState.column === 4) {
                    valA = Number(valA);
                    valB = Number(valB);
                }

                if (valA < valB) return sortState.ascending ? -1 : 1;
                if (valA > valB) return sortState.ascending ? 1 : -1;
                return 0;
            });
            
            // Populate Body
            resultsBody.innerHTML = dataRows.map(row => {
                const rowData = row.map((cell, index) => {
                    // Format the date for better readability if it's in the date column (index 2)
                    if (index === 2 && String(cell).includes('T') && String(cell).includes('Z')) {
                        return `<td class="py-3 px-4">${new Date(cell).toLocaleString()}</td>`;
                    }
                    return `<td class="py-3 px-4">${cell}</td>`;
                }).join('');
                return `<tr>${rowData}</tr>`;
            }).join('');
        }

        /**
         * Fetches all results from the Google Sheet
         */
        async function fetchResults() {
            loadingSpinner.style.display = 'block';
            resultsContainer.classList.add('hidden');
            try {
                const url = `${SCRIPT_URL}?action=getResults`;
                // Simplified the fetch call directly.
                const response = await fetch(url, { method: 'GET', redirect: 'follow' });

                if (!response.ok) {
                    // Throw a more detailed error for better debugging.
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data && data.length > 1) { // Check for more than just a header row
                    allResults = data;
                    renderTable();
                } else {
                    resultsContainer.innerHTML = '<p class="text-center py-4">No results found.</p>';
                }
            } catch (error) {
                // Log the full error object and display a more helpful message.
                console.error('Failed to fetch results:', error);
                resultsContainer.innerHTML = `<p class="text-center py-4 text-red-500">Error loading data. Details: ${error.message}. Please check your connection and script URL.</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
                resultsContainer.classList.remove('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        refreshButton.addEventListener('click', fetchResults);

        headerRow.addEventListener('click', (e) => {
            if (e.target.tagName === 'TH') {
                const colIndex = Number(e.target.dataset.colIndex);
                if (sortState.column === colIndex) {
                    sortState.ascending = !sortState.ascending;
                } else {
                    sortState.column = colIndex;
                    sortState.ascending = true;
                }
                renderTable();
            }
        });

        // --- INITIAL LOAD ---
        fetchResults();
    </script>
</body>
</html>
