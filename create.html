<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-field {
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.4); /* Violet ring */
            border-color: #a78bfa; /* Violet-300 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-xl font-bold text-gray-800">Admin Panel</div>
            <div>
                <a href="index.html" class="text-gray-600 hover:text-violet-600 px-3 py-2">Student View</a>
                <a href="dashboard.html" class="text-gray-600 hover:text-violet-600 px-3 py-2">Results Dashboard</a>
                <a href="create.html" class="font-semibold text-violet-600 border-b-2 border-violet-600 px-3 py-2">Create Quiz</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-8">
        <div class="max-w-4xl mx-auto bg-white p-4 sm:p-8 rounded-lg shadow-lg">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Quiz Builder</h1>
            
            <form id="create-quiz-form" class="space-y-6">
                <!-- Quiz Title -->
                <div>
                    <label for="quiz-title" class="block text-lg font-medium text-gray-700 mb-2">Quiz Title</label>
                    <input type="text" id="quiz-title" name="quiz-title" class="input-field block w-full border-gray-300 rounded-lg shadow-sm p-3" placeholder="e.g., Dative Prepositions" required>
                </div>

                <!-- Sentences Container -->
                <div id="sentences-container" class="space-y-4">
                    <h2 class="text-lg font-medium text-gray-700 pt-2">Sentences</h2>
                    <!-- Sentence pair inputs will be added here dynamically -->
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-between pt-4">
                    <button type="button" id="add-sentence-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">
                        Add Sentence
                    </button>
                    <button type="submit" id="save-quiz-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">
                        Save Quiz
                    </button>
                </div>
            </form>
            
            <!-- Status Message -->
            <div id="status-message" class="mt-6 text-center font-semibold"></div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMVkf9FKMJYoCfxI9knHZHicOpJiK-Td9yRHmi4n34riDj6t8F3kmYaDok3MjTYNAUQg/exec";

        // --- DOM ELEMENTS ---
        const form = document.getElementById('create-quiz-form');
        const sentencesContainer = document.getElementById('sentences-container');
        const addSentenceBtn = document.getElementById('add-sentence-btn');
        const statusMessage = document.getElementById('status-message');
        const saveButton = document.getElementById('save-quiz-btn');

        let sentenceCount = 0;

        /**
         * Adds a new pair of input fields for a German/English sentence.
         */
        function addSentencePair() {
            sentenceCount++;
            const sentenceDiv = document.createElement('div');
            sentenceDiv.className = 'sentence-pair p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50';
            sentenceDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold text-gray-600">Sentence ${sentenceCount}</p>
                    <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-semibold">Remove</button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">English Sentence</label>
                    <input type="text" class="input-field english-input mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">German Sentence</label>
                    <input type="text" class="input-field german-input mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
            `;
            sentencesContainer.appendChild(sentenceDiv);

            // Add event listener to the new remove button
            sentenceDiv.querySelector('.remove-btn').addEventListener('click', () => {
                sentenceDiv.remove();
                // Note: sentenceCount does not decrease, but this is okay as it's just for display.
            });
        }

        /**
         * Handles the form submission to save the quiz.
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            saveButton.disabled = true;
            statusMessage.textContent = 'Saving quiz...';
            statusMessage.className = 'mt-6 text-center font-semibold text-blue-600';

            const quizTitle = document.getElementById('quiz-title').value;
            const sentencePairs = document.querySelectorAll('.sentence-pair');
            
            const sentences = [];
            sentencePairs.forEach(pair => {
                const en = pair.querySelector('.english-input').value.trim();
                const de = pair.querySelector('.german-input').value.trim();
                if (en && de) {
                    sentences.push({ en, de });
                }
            });

            if (!quizTitle || sentences.length === 0) {
                statusMessage.textContent = 'Please provide a title and at least one sentence.';
                statusMessage.className = 'mt-6 text-center font-semibold text-red-500';
                saveButton.disabled = false;
                return;
            }
            
            const quizData = JSON.stringify({ title: quizTitle, sentences: sentences });

            const payload = {
                quizTitle: quizTitle,
                quizData: quizData
            };
            
            try {
                // *** FIX APPLIED HERE ***
                // Simplified the fetch call, which can resolve CORS issues.
                const url = `${SCRIPT_URL}?action=addQuiz`;
                const response = await fetch(url, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const result = await response.json();

                if (result.result === 'success') {
                    statusMessage.textContent = `Quiz "${quizTitle}" saved successfully!`;
                    statusMessage.className = 'mt-6 text-center font-semibold text-green-600';
                    form.reset();
                    sentencesContainer.innerHTML = '<h2 class="text-lg font-medium text-gray-700 pt-2">Sentences</h2>'; // Clear sentences
                    sentenceCount = 0;
                    addSentencePair(); // Add one empty pair for the next quiz
                } else {
                    throw new Error(result.error || 'Unknown error from script.');
                }

            } catch (error) {
                console.error('Failed to save quiz:', error);
                statusMessage.textContent = `Error: Could not save quiz. ${error.message}`;
                statusMessage.className = 'mt-6 text-center font-semibold text-red-500';
            } finally {
                saveButton.disabled = false;
            }
        }

        // --- EVENT LISTENERS ---
        addSentenceBtn.addEventListener('click', addSentencePair);
        form.addEventListener('submit', handleFormSubmit);

        // --- INITIAL LOAD ---
        // Start with one empty sentence pair ready to be filled out.
        addSentencePair();
    </script>
</body>
</html>
